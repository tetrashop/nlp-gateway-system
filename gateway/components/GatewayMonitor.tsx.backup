'use client';

import React, { useState, useEffect } from 'react';

const GatewayMonitor = () => {
  const [services, setServices] = useState([]);
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  
  const gatewayServices = [
    { id: 'auth', name: 'Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª', endpoint: '/api/v1/auth', color: 'blue' },
    { id: 'users', name: 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', endpoint: '/api/v1/users', color: 'green' },
    { id: 'nlp', name: 'Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ØªÙ†', endpoint: '/api/v1/nlp', color: 'purple' },
    { id: 'payments', name: 'Ù¾Ø±Ø¯Ø§Ø®Øª', endpoint: '/api/v1/payments', color: 'yellow' },
    { id: 'documents', name: 'Ø§Ø³Ù†Ø§Ø¯', endpoint: '/api/v1/documents', color: 'pink' },
    { id: 'ai', name: 'Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ', endpoint: '/api/v1/ai', color: 'indigo' },
    { id: 'analytics', name: 'ØªØ­Ù„ÛŒÙ„', endpoint: '/api/v1/analytics', color: 'red' },
    { id: 'storage', name: 'Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ', endpoint: '/api/v1/storage', color: 'teal' }
  ];
  
  useEffect(() => {
    checkAllServices();
    const interval = setInterval(checkAllServices, 30000); // Ù‡Ø± Û³Û° Ø«Ø§Ù†ÛŒÙ‡
    return () => clearInterval(interval);
  }, []);
  
  const checkAllServices = async () => {
    setLoading(true);
    const serviceChecks = [];
    
    for (const service of gatewayServices) {
      try {
        const start = Date.now();
        const response = await fetch(service.endpoint);
        const latency = Date.now() - start;
        
        serviceChecks.push({
          ...service,
          status: response.ok ? 'online' : 'error',
          latency,
          lastChecked: new Date().toLocaleTimeString('fa-IR')
        });
      } catch (error) {
        serviceChecks.push({
          ...service,
          status: 'offline',
          latency: 0,
          lastChecked: new Date().toLocaleTimeString('fa-IR'),
          error: error.message
        });
      }
      
      // ØªØ£Ø®ÛŒØ± Ø¨ÛŒÙ† Ú†Ú©â€ŒÙ‡Ø§
      await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    setServices(serviceChecks);
    
    // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¢Ù…Ø§Ø±
    const onlineCount = serviceChecks.filter(s => s.status === 'online').length;
    const avgLatency = serviceChecks
      .filter(s => s.status === 'online')
      .reduce((sum, s) => sum + s.latency, 0) / onlineCount || 0;
    
    setStats({
      total: serviceChecks.length,
      online: onlineCount,
      offline: serviceChecks.length - onlineCount,
      avgLatency: avgLatency.toFixed(0),
      lastUpdate: new Date().toLocaleTimeString('fa-IR')
    });
    
    setLoading(false);
  };
  
  const testGateway = async (serviceId, endpoint) => {
    try {
      const response = await fetch(`/api/v1/${serviceId}`);
      const data = await response.json();
      alert(`âœ… ${serviceId} Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯:\n${JSON.stringify(data, null, 2)}`);
    } catch (error) {
      alert(`âŒ Ø®Ø·Ø§ Ø¯Ø± ${serviceId}: ${error.message}`);
    }
  };
  
  return (
    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-2xl font-bold text-gray-800 dark:text-white">
          Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Gateway
        </h2>
        <div className="flex items-center space-x-2">
          <button
            onClick={checkAllServices}
            disabled={loading}
            className="px-4 py-2 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-lg disabled:opacity-50"
          >
            {loading ? 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...' : 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ'}
          </button>
          <span className="text-sm text-gray-500">
            {stats?.lastUpdate}
          </span>
        </div>
      </div>
      
      {/* Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ */}
      {stats && (
        <div className="grid grid-cols-3 gap-4 mb-6">
          <div className="bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/30 p-4 rounded-xl">
            <div className="text-2xl font-bold text-gray-800 dark:text-white">
              {stats.online}/{stats.total}
            </div>
            <div className="text-sm text-green-600 dark:text-green-400 mt-1">
              Ø³Ø±ÙˆÛŒØ³ ÙØ¹Ø§Ù„
            </div>
          </div>
          
          <div className="bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 p-4 rounded-xl">
            <div className="text-2xl font-bold text-gray-800 dark:text-white">
              {stats.avgLatency}ms
            </div>
            <div className="text-sm text-blue-600 dark:text-blue-400 mt-1">
              ØªØ£Ø®ÛŒØ± Ù…ØªÙˆØ³Ø·
            </div>
          </div>
          
          <div className="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-900/30 dark:to-gray-800/30 p-4 rounded-xl">
            <div className="text-2xl font-bold text-gray-800 dark:text-white">
              {stats.offline}
            </div>
            <div className="text-sm text-gray-600 dark:text-gray-400 mt-1">
              Ø³Ø±ÙˆÛŒØ³ ØºÛŒØ±ÙØ¹Ø§Ù„
            </div>
          </div>
        </div>
      )}
      
      {/* Ù„ÛŒØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ */}
      <div className="space-y-3">
        {services.map((service) => (
          <div 
            key={service.id} 
            className="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition"
          >
            <div className="flex items-center space-x-3 space-x-reverse">
              <div className={`w-3 h-3 rounded-full ${
                service.status === 'online' ? 'bg-green-500 animate-pulse' :
                service.status === 'error' ? 'bg-yellow-500' : 'bg-red-500'
              }`}></div>
              <div>
                <div className="font-medium text-gray-800 dark:text-gray-200">
                  {service.name}
                </div>
                <div className="text-sm text-gray-500 dark:text-gray-400">
                  {service.endpoint}
                </div>
              </div>
            </div>
            
            <div className="flex items-center space-x-4 space-x-reverse">
              <div className="text-right">
                <div className="text-sm text-gray-600 dark:text-gray-400">
                  {service.lastChecked}
                </div>
                <div className={`text-xs ${
                  service.status === 'online' ? 'text-green-600' :
                  service.status === 'error' ? 'text-yellow-600' : 'text-red-600'
                }`}>
                  {service.status === 'online' ? `${service.latency}ms` : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                </div>
              </div>
              
              <button
                onClick={() => testGateway(service.id, service.endpoint)}
                className="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-500"
              >
                ØªØ³Øª
              </button>
            </div>
          </div>
        ))}
      </div>
      
      {/* Ø§Ø·Ù„Ø§Ø¹Ø§Øª Gateway */}
      <div className="mt-6 pt-6 border-t dark:border-gray-700">
        <div className="text-sm text-gray-600 dark:text-gray-400">
          <div className="flex items-center justify-between">
            <span>ğŸŒ Gateway Endpoint:</span>
            <code className="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
              /api/v1/{'{}service{}'}
            </code>
          </div>
          <div className="flex items-center justify-between mt-2">
            <span>ğŸ“Š Ú©Ù„ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§:</span>
            <span className="font-medium">Û²Û¸ Ø³Ø±ÙˆÛŒØ³</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default GatewayMonitor;
